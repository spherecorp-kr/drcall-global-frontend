name: ğŸš€ Deploy Patient App

on:
  push:
    branches:
      - main
      - staging
      - develop
    paths:
      - 'apps/patient-app/**'
      - 'packages/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  # Determine environment from branch or input
  determine-env:
    name: ğŸ¯ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="prod"
          elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            ENV="staging"
          else
            ENV="dev"
          fi

          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "ğŸ“ Deploying to: ${ENV}"

  deploy-dev:
    name: ğŸš€ Deploy to DEV
    needs: determine-env
    if: needs.determine-env.outputs.environment == 'dev'
    uses: ./.github/workflows/_reusable-app-deploy.yml
    with:
      app-name: patient-app
      build-command: build:patient
      environment: dev
    secrets:
      CLOUDFRONT_ID: ${{ secrets.PATIENT_APP_DEV_CLOUDFRONT_ID }}

  deploy-staging:
    name: ğŸš€ Deploy to STAGING
    needs: determine-env
    if: needs.determine-env.outputs.environment == 'staging'
    uses: ./.github/workflows/_reusable-app-deploy.yml
    with:
      app-name: patient-app
      build-command: build:patient
      environment: staging
    secrets:
      CLOUDFRONT_ID: ${{ secrets.PATIENT_APP_STAGING_CLOUDFRONT_ID }}

  deploy-prod:
    name: ğŸš€ Deploy to PRODUCTION
    needs: determine-env
    if: needs.determine-env.outputs.environment == 'prod'
    uses: ./.github/workflows/_reusable-app-deploy.yml
    with:
      app-name: patient-app
      build-command: build:patient
      environment: prod
    secrets:
      CLOUDFRONT_ID: ${{ secrets.PATIENT_APP_PROD_CLOUDFRONT_ID }}
